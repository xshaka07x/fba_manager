<!-- templates/products.html -->
{% extends "base.html" %}

{% block title %}Produits - FBA Manager{% endblock %}

{% block content %}

<style>
    .nom-col {
        max-width: 300px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
</style>

<div class="container mt-4">
    <h1 class="mb-4">ðŸ“¦ Gestion des Produits</h1>
    <table class="table table-dark table-hover data-table">
        <thead>
            <tr>
                <th>#</th>
                <th>Nom</th>
                <th>EAN</th>
                <th>Prix Retail</th>
                <th>Prix Amazon</th>
                <th>ROI</th>
                <th>Profit</th>
                <th>Ventes EstimÃ©es</th>
                <th>Lien</th>
                <th>Date</th>
            </tr>
        </thead>
        <tbody>
            {% for product in produits %}
            <tr class="
                {% if product.roi < 19 %}
                    roi-low
                {% elif product.roi >= 20 and product.roi <= 59 %}
                    roi-medium
                {% elif product.roi >= 60 and product.roi <= 80 %}
                    roi-high
                {% else %}
                    roi-excellent
                {% endif %}
            ">
                <th scope="row">{{ loop.index }}</th>
                <td class="nom-col" title="{{ product.nom }}">{{ product.nom }}</td>
                <td>{{ product.ean }}</td>
                <td>${{ product.prix_retail }}</td>
                <td>${{ product.prix_amazon }}</td>
                <td>{{ product.roi }}%</td>
                <td>${{ product.profit }}</td>
                <td>{{ product.sales_estimation }}</td>
                <td><a href="{{ product.url }}" target="_blank" class="btn btn-outline-info btn-sm">Lien</a></td>
                <td>{{ product.updated_at }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<div class="card shadow-lg p-3 mb-4">
    <div class="card-header bg-dark text-white">
        <h5 class="text-uppercase fw-bold">ðŸ“ˆ Ã‰volution des prix</h5>
    </div>
    <div class="card-body">
        <select id="productSelector" class="form-select mb-3">
            <option value="">SÃ©lectionner un produit</option>
            {% for product in produits %}
            <option value="{{ product.id }}">{{ product.nom }}</option>
            {% endfor %}
        </select>
        <canvas id="priceChart"></canvas>
    </div>
</div>

<script>
    document.getElementById("productSelector").addEventListener("change", function() {
        let productId = this.value;
        if (!productId) return;

        fetch(`/historique_prix/${productId}`)
            .then(response => response.json())
            .then(data => {
                let labels = data.map(entry => entry.date);
                let prixRetail = data.map(entry => entry.prix_retail);
                let prixAmazon = data.map(entry => entry.prix_amazon);

                let ctx = document.getElementById("priceChart").getContext("2d");
                if (window.priceChart) {
                    window.priceChart.destroy();
                }
                window.priceChart = new Chart(ctx, {
                    type: "line",
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: "Prix Retail (â‚¬)",
                                data: prixRetail,
                                borderColor: "rgba(255, 99, 132, 1)",
                                backgroundColor: "rgba(255, 99, 132, 0.2)",
                                borderWidth: 2
                            },
                            {
                                label: "Prix Amazon (â‚¬)",
                                data: prixAmazon,
                                borderColor: "rgba(54, 162, 235, 1)",
                                backgroundColor: "rgba(54, 162, 235, 0.2)",
                                borderWidth: 2
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            });
    });
</script>


{% endblock %}
