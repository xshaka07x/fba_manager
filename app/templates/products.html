<!-- templates/products.html -->
{% extends "base.html" %}

{% block title %}Produits - FBA Manager{% endblock %}

{% block content %}

<style>
    .nom-col {
        max-width: 300px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .roi-low { background-color: rgba(255, 0, 0, 0.2) !important; }
    .roi-medium { background-color: rgba(144, 238, 144, 0.2) !important; }
    .roi-high { background-color: rgba(0, 128, 0, 0.2) !important; }
    .roi-excellent { background-color: rgba(128, 0, 128, 0.2) !important; }
</style>

<div class="container mt-4">
    <h1 class="mb-4">üì¶ Gestion des Produits</h1>
    
    <!-- Onglets pour basculer entre les sources -->
    <ul class="nav nav-tabs mb-4">
        <li class="nav-item">
            <a class="nav-link active" data-bs-toggle="tab" href="#keepa">Keepa</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#scan">Scan</a>
        </li>
    </ul>

    <div class="tab-content">
        <!-- Tableau Keepa -->
        <div class="tab-pane fade show active" id="keepa">
            <table class="table table-dark table-hover data-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Nom</th>
                        <th>EAN</th>
                        <th>Prix Retail</th>
                        <th>Prix Amazon</th>
                        <th>ROI</th>
                        <th>Profit</th>
                        <th>Lien</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in produits_keepa %}
                    <tr class="
                        {% if product.roi < 19 %}roi-low
                        {% elif product.roi >= 20 and product.roi <= 59 %}roi-medium
                        {% elif product.roi >= 60 and product.roi <= 79 %}roi-high
                        {% else %}roi-excellent{% endif %}">
                        <th scope="row">{{ loop.index }}</th>
                        <td class="nom-col" title="{{ product.nom }}">{{ product.nom }}</td>
                        <td>{{ product.ean }}</td>
                        <td>{{ "%.2f"|format(product.prix_retail) }}‚Ç¨</td>
                        <td>{{ "%.2f"|format(product.prix_amazon) }}‚Ç¨</td>
                        <td>{{ "%.2f"|format(product.roi) }}%</td>
                        <td>{{ "%.2f"|format(product.profit) }}‚Ç¨</td>
                        <td><a href="{{ product.url }}" target="_blank" class="btn btn-outline-info btn-sm">Lien</a></td>
                        <td>{{ product.updated_at.strftime('%d/%m/%Y %H:%M') }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Tableau Scan -->
        <div class="tab-pane fade" id="scan">
            <table class="table table-dark table-hover data-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Nom</th>
                        <th>EAN</th>
                        <th>Prix Retail</th>
                        <th>Prix Amazon</th>
                        <th>Diff√©rence</th>
                        <th>ROI</th>
                        <th>Profit</th>
                        <th>Lien</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in produits_scan %}
                    <tr class="
                        {% if product.roi < 19 %}roi-low
                        {% elif product.roi >= 20 and product.roi <= 59 %}roi-medium
                        {% elif product.roi >= 60 and product.roi <= 79 %}roi-high
                        {% else %}roi-excellent{% endif %}">
                        <th scope="row">{{ loop.index }}</th>
                        <td class="nom-col" title="{{ product.nom }}">{{ product.nom }}</td>
                        <td>{{ product.ean }}</td>
                        <td class="text-success">{{ "%.2f"|format(product.prix_retail) }}‚Ç¨</td>
                        <td class="text-info">{{ "%.2f"|format(product.prix_amazon) }}‚Ç¨</td>
                        <td class="{% if product.difference > 0 %}text-success{% else %}text-danger{% endif %}">
                            {{ "%.2f"|format(product.difference) }}‚Ç¨
                        </td>
                        <td class="{% if product.roi >= 80 %}text-success{% elif product.roi >= 60 %}text-info{% elif product.roi >= 20 %}text-warning{% else %}text-danger{% endif %}">
                            {{ "%.2f"|format(product.roi) }}%
                        </td>
                        <td class="{% if product.profit > 0 %}text-success{% else %}text-danger{% endif %}">
                            {{ "%.2f"|format(product.profit) }}‚Ç¨
                        </td>
                        <td>
                            {% if product.url %}
                            <a href="{{ product.url }}" target="_blank" class="btn btn-outline-info btn-sm">Lien</a>
                            {% endif %}
                        </td>
                        <td>{{ product.updated_at.strftime('%d/%m/%Y %H:%M') }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>



<script>
    function fetchHistorique(produitId) {
        fetch(`/historique/${produitId}`)
            .then(response => response.json())
            .then(data => {
                let message = "Historique des prix :\n";
                if (data.length === 0) {
                    message += "Aucune donn√©e disponible.";
                } else {
                    data.forEach(item => {
                        message += `üìÜ ${item.date} : ${item.prix_retail}‚Ç¨ (Amazon: ${item.prix_amazon || 'N/A'}‚Ç¨)\n`;
                    });
                }
                alert(message);
            })
            .catch(error => console.error("Erreur r√©cup√©ration historique :", error));
    }
</script>

{% endblock %}
